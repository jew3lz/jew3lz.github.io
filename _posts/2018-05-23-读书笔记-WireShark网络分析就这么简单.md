---
layout:     post
title:      读书笔记(WireShark 网络分析就是这么简单)
subtitle:   概括性读书笔记
date:       2018-05-23
author:     jew3lz
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - WireShark
    - TCP
---

# Wireshark 网络分析
## TCP 有序传输
Seq = lastSeq + lastLength, ACK = nextSeq, ACK 可以代表累计回复. 可以通过 Seq判断缺包, 若包丢失, 回复 ack:lostSeq 提醒发送方重传
## TCP 窗口
Window Size Value 是向对方声明自己的接收窗口
TCP Window Scale 是指 65535的倍数(2的 n 次)
## 重传相关
发送方的发送窗口受接收方的接受窗口和网络影响. 限制更严的起作用, 发送窗口通过 Win=X 告知发送方. 网络的影响就是要将发送窗口控制在拥塞点以下.
靠谱的策略是在发送方维护一个拥塞窗口, 利用各种算法使它接近真实拥塞点. 
算法: 
1. 连接建立伊始, 避免拥塞会将初始值定比较小, 个位数的 MSS
2. 连续发包都得到确认, 会倍数增加 MSS, 增速很快, 但是基数小, 所以速度慢称之为慢启动
3. 持续一段时间后, 到了一个较大的值, 就改用每个往返时间增加一个 MSS, 避免拥塞. 称之为拥塞避免.这个较大的值以之前拥塞的点作为参考, 若无则取相对大的值如和最大接收窗口相等.

若发生了超时重传(等待一段时间后, 迟迟收不到包), 发出原始包到重传这个包的时间成为 RTO,RTO 的取值通过多个公式计算出来. 
发生重传之后, 拥塞窗口降到上次发生拥塞时的窗口的一半(RFC定义)或1个 MSS. RTO 对性能的影响极大, 某些操作系统支持调整.
![](img/TCP/traffic.png)

WireShark 检查重传:Analyze-Expert Info Composite.
与超时重传不同, 拥塞轻微时, 丢失少量包而后续包正常到达, 接收方就每收到一个包Ack 需要的 Seq 号提醒重传, 若发送方连续收到3个或以上Dup Ack, 感知丢失而立即重传, 这就是快速重传. 因为不需要像超时一样等待一段时间. 需要凑满三个的原因是网络包有时会乱序且一般乱序的距离不会相差太大. 
快速重传不需要大幅调整拥塞窗口, 因为后续包到达说明没有严重拥塞. 拥塞窗口的大小继续保留在拥塞避免阶段, 设为新的临街窗口值(发生拥塞时的为确认的包量的1/2)加3个 MSS. 称之为快恢复.
(img)

总结:
1. 没有拥塞时, 发送窗口越大性能越好. Windows 可以启用 Scale Opotion 来增加性能. 
2. 发生拥塞, 限制发送窗口反而提高性能, 重传极度影响性能. 
3. 超时重传影响最大,  RTO 时间不传输任何数据, 拥塞窗口也会极大缩小.
4. 快速重传性能影响小一些, 窗口减小幅度不大,  也没有等待时间.
5. 复杂丢包情况下, SACK(每次 Ack 需要的包将收到的包也告知) 和NewReno(丢包窟窿补满后主动Ack 新包, 但是丢包量很大时需要花费多个 RTT) 算法有利于提高性能.
6. 丢包对小文件影响比大文件严重. 丢包时凑不够3个 Dup Ack, 只能等待超时重传. 大文件触发快重传.

## 延迟确认&Nagle 算法
延迟确认:收到一个包之后暂时无数据要发送, 就延迟一段时间再确认(Windows:200ms), 这段时间内恰好有数据要发送再将确认和和数据放到一个包里发出去. 
Nagle 算法:发出去的数据**未确认**之前, 如果又有小数据生成, 将小数据收集起来凑满一个 MSS 或等收到确认之后再发送.
这两个算法都没有直接提高性能, 启用的作用只是提高传输效率, 减少网络负担.某些时候会降低性能, 某些软件默认就是选中的. 

## 百家争鸣
Westwood: 根据推算出的已送达接收方的包数, 精确估算发生拥塞时的带宽, 根据带宽来设置新的拥塞窗口.
Vegas: 通过监控网络状态来调整窗口,如 RTT 稳定->增大, 数据包排队->减小.但是需要环境中所有都需要使用 Vegas, 不然会被频繁加塞.
每个操作系统的不同版本可能使用不同的拥塞算法.

## UDP
特点: 协议头短, 单包数据利用率高,省去建立连接的负担
缺点:
1. 不考虑 MTU,网络层负责分片,接收方组装. 消耗资源降低性能.
2. UDP 没有重传, 丢包由应用层处理, 有一个包丢失重传整个操作所需包. TCP 只需重传1个
3. 分片机制存在隐患, 每个包都有 More fragments 的 flag表示是否还有分片, 若一直发送为1的分片,接收方无法组装就会耗尽内存.

## DNS
访问域名时, 可以通过抓包看到与域名服务器的交互. 查询 A 记录;
nslookup 可以查询 PTR 记录(IP-> 域名)

递归查询:User->DNS server->权威 DNS Server->User
迭代查询:User->DNS DNS->User->权威 DNSServer IP User->权威 DNS ServerIP

当有多个 IP 对应同名 A 记录时, DNS 会轮询(round-robin), 可应用于负载均衡

## FTP
FTP 使用明文传输, 不安全.
客户端连接 FTP 服务器的21端口仅为传输控制信息, 传输数据时会新建 TCP 连接, 结束就连接管壁.

## HTTP
HTTP 基于 TCP,请求过程是握手后交互.
HTTP 不安全, HTTPS 相对较安全(无法获得秘钥情况下)

## 性能指标三板斧
Summmary, Service Response Time, Expert Info Composite

TShark 支持 script 编写, 功能更强大
